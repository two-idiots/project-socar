<!DOCTYPE html>
<html lang="en" ng-app="test">
<head>
	<meta charset="UTF-8">
	<title>Document</title><meta name="viewport" content="width=device-width, initial-scale=0.41, maximum-scale=1" />
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>

   	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://apis.daum.net/maps/maps3.js?apikey=007981f5ae987412b8eeb43d18960bdd"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
	<script>
		/**
		* test Module
		*
		* Description
		*/
		angular.module('test', [])
		.controller('mainController', ['$scope', '$rootScope', '$http', '$window', function($scope, $rootScope, $http, $window){
			var container = angular.element($('#map'));
			var options = {
				center : new daum.maps.LatLng(35.151254,129.0100113),
				level : 5
			};
			var map = new daum.maps.Map(container[0], options);
			var content = '<div style="left:0px; top:0px; width:100%;"><a style="display:block;padding:0 25px 0 10px;height:31px;font-size:13px;font-weight:bold;line-height:31px;white-space:nowrap;background:url(https://dwrr4uupj8j1p.cloudfront.net/template/asset/images/bullet.png) no-repeat 100% -89px;background-size:18px auto;" href="#">';
			
			var preClickMarkerLatLag;
			// 이전 marker의 lat, lng 값
			var infowindow = [];
			// infowindow 저장

			var posIndex = 0;

			$scope.$watch('$viewContentLoaded', function(){
				$http.post('http://10.1.65.64:3000/reserve/area_info', {}).success(function(res){
						console.log(res);
						$scope.marker = res;
						var size = $scope.marker.length;

						for(var i=0;i<size;i++){
							var lat = $scope.marker[i].latitude;
							var lng = $scope.marker[i].longitude;

							var marker = new daum.maps.Marker({
						        map: map, // 마커를 표시할 지도
						        position: new daum.maps.LatLng(lat, lng) // 마커의 위치
						    });

						    // 마커에 표시할 인포윈도우를 생성합니다 
						    infowindow[i] = new daum.maps.InfoWindow({
						        content: content + $scope.marker[i].area_name + "</a></div>" // 인포윈도우에 표시할 내용
						    });

							// 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
							// 이벤트 리스너로는 클로저를 만들어 등록합니다 
							// for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
							daum.maps.event.addListener(marker, 'click', openInfoWindowListener(i, map, marker, infowindow));
						}
					}).error(function(res){
						console.log(res);
					});
			});
			
			// 인포윈도우를 표시하는 클로저를 만드는 함수
			function openInfoWindowListener(idx, map, marker, infowindow) {
			    return function() {
			    	if(marker.getPosition() !== preClickMarkerLatLag){
			    		infowindow[posIndex].close();
			    		// 이전 infowindow 닫기
						preClickMarkerLatLag = marker.getPosition();
						posIndex = idx;
						// 현재 marker 및 index 대입
			    	}
			        infowindow[idx].open(map, marker);
			        // infowindow 열기
			        infowindow[idx].Af.onclick = function(){
			        	// console.log(infowindow[idx].Af.textContent);
			        	$rootScope.marker = infowindow[idx].Af.textContent;
			        	$window.location = "confirm.html";
			        };
			    };
			}
		}])
	</script>
	<style>
		* {margin : 0; padding : 0;}
		html, body{
			height: 100%;
			width : 100%;
		}
		a, u{
			text-decoration: none;
			background-color: black;
		}
		a:focus{
			color: #000;
		}
	</style>
	<!-- 단말기 크기에 맞게끔 지도 크기 % 조절 -->
</head>
<body ng-controller="mainController">
	<div id="map" style="margin:0; width:100%; height:100%;"></div>
</body>
</html>